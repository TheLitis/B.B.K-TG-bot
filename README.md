## Lgpol / ¬´–í.–í.–ö.¬ª Telegram Bot

–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ `aiogram 3`, –∫–æ—Ç–æ—Ä—ã–π:

- –≤–µ–¥—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –º–∞—Å—Ç–µ—Ä—É –ø–æ–¥–±–æ—Ä–∞, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—è –º–µ—Ç—Ä–∞–∂ –∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ª–∏—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π;
- –¥–∞—ë—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤;
- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ ¬´–ø–æ–¥–±–æ—Ä–∫—É¬ª —Å —Ä–∞—Å—á—ë—Ç–∞–º–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–æ–º –≤ Excel;
- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–æ–±—Ä–∞–∑—Ü—ã, –ø–∞—Å–ø–æ—Ä—Ç, —Å—á—ë—Ç, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å);
- –∑–∞—â–∏—â–∞–µ—Ç—Å—è –æ—Ç —Ñ–ª—É–¥–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º rate-limit middleware;
- –≥—Ä—É–∑–∏—Ç —Ç–µ–∫—Å—Ç—ã, —Å—Ç–∏–ª–∏, –∫–∞—Ç–∞–ª–æ–≥ –∏ FAQ –∏–∑ –ø–∞–ø–∫–∏ `data/` ‚Äî –±–µ–∑ –ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞.

---

## Quick start

```bash
python -m venv .venv
.venv\Scripts\activate  # Windows
# source .venv/bin/activate  # macOS/Linux

pip install -e .[dev]
cp .env.example .env  # –∏–ª–∏ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–π—Ç–µ .env
```

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env`:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è           | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                             |
|----------------------|--------------------------------------------------------|
| `BOT_TOKEN`          | —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ –∏–∑ @BotFather                      |
| `MANAGER_CHAT_ID`    | ID —á–∞—Ç–∞/–≥—Ä—É–ø–ø—ã, –∫—É–¥–∞ –ø—Ä–∏–ª–µ—Ç–∞—é—Ç –∑–∞—è–≤–∫–∏                  |
| `AUTOSAVE_SELECTION` | `true/false`, —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–¥–±–æ—Ä–∫—É –≤ `tmp/`              |
| `USE_WEBHOOK`        | `false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é long polling)                    |
| `WEBHOOK_URL`        | HTTPS URL, –µ—Å–ª–∏ –≤–∫–ª—é—á–∞–µ—Ç–µ webhook                      |
| `WEBAPP_HOST/PORT`   | –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ webhook-—Å–µ—Ä–≤–µ—Ä–∞               |

–ó–∞–ø—É—Å–∫:

```bash
python -m bot.main
```

- long polling —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º `deleteWebhook`.
- –ø—Ä–∏ `USE_WEBHOOK=true` –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è webhook-—Å–µ—Ä–≤–µ—Ä –Ω–∞ `WEBAPP_HOST:WEBAPP_PORT`.

---

## –ì–¥–µ –ª–µ–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç

- `data/catalog.json` ‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ñ–∏–ª—å—Ç—Ä—ã, –∫–∞—Ä—Ç–æ—á–∫–∏ (SKU, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, pack_step).
- `data/styles.yaml` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, —Ç–µ–∫—Å—Ç—ã –∫–Ω–æ–ø–æ–∫, —à–∞–±–ª–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞, —Å–æ–æ–±—â–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞.
- `data/delivery.md`, `data/faq.md` ‚Äî –≥–æ—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ ¬´–î–æ—Å—Ç–∞–≤–∫–∞/–û–ø–ª–∞—Ç–∞¬ª –∏ FAQ.
- `data/company.json` ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ ¬´üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã¬ª.
- `tmp/selection_*.json` ‚Äî –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è).

–ò–∑–º–µ–Ω—è–µ—Ç–µ —Ñ–∞–π–ª ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –±–æ—Ç–∞ ‚Üí —Ç–µ–∫—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.

---

## –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

| –ú–µ–Ω—é               | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                                                 |
|--------------------|-----------------------------------------------------------------------------|
| üß≠ –ü–æ–¥–±–æ—Ä          | FSM‚Äë–º–∞—Å—Ç–µ—Ä (–æ–±—ä–µ–∫—Ç ‚Üí –º–∞—Ç–µ—Ä–∏–∞–ª ‚Üí –∫–ª–∞—Å—Å ‚Üí –¥–∏–∑–∞–π–Ω ‚Üí –ø–ª–æ—â–∞–¥—å ‚Üí –±—é–¥–∂–µ—Ç)          |
| üõç –ö–∞—Ç–∞–ª–æ–≥         | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã, –≤–æ–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ |
| üöö –î–æ—Å—Ç–∞–≤–∫–∞        | –ë–ª–æ–∫ –∏–∑ `delivery.md` + –∫–Ω–æ–ø–∫–∏ ¬´–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å¬ª / ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª–æ–≥–∏—Å—Ç–∏–∫—É¬ª      |
| üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã        | –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ + –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç¬ª                              |

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

- –ò–Ω–ª–∞–π–Ω‚Äë–∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞: `üì¶ –û–±—Ä–∞–∑—Ü—ã`, `üìÑ –ü–∞—Å–ø–æ—Ä—Ç`, `‚úâÔ∏è –ó–∞–ø—Ä–æ—Å —Å—á—ë—Ç–∞`, `‚ûï –í –ø–æ–¥–±–æ—Ä–∫—É`.
- –ü–æ–¥–±–æ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏: `üóë –û—á–∏—Å—Ç–∏—Ç—å`, `üìä –≠–∫—Å–ø–æ—Ä—Ç XLSX`, `‚úâÔ∏è –ú–µ–Ω–µ–¥–∂–µ—Ä—É`.
- –í—Å–µ –∑–∞—è–≤–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—é—Ç—Å—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º username/—Å—Å—ã–ª–∫–æ–π (`tg://user?id=‚Ä¶`).
- –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –±–æ—Ç –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.

---

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞

- –°–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —à–∞–≥–µ (–±–µ–∑ ¬´—Å–ø–∞–º–∞¬ª –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫).
- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏—è (—Ä–∞–∑–¥–µ–ª ¬´üìå –£–∂–µ –≤—ã–±—Ä–∞–Ω–æ¬ª).
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ñ–∏–ª—å—Ç—Ä-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–µ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
- –î–æ 6 –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ –≤—ã–¥–∞—á—É, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —á–∞—Ç.

---

## –ü–æ–¥–±–æ—Ä–∫–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç

- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SKU —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø–ª–æ—â–∞–¥—å, –∑–∞–ø–∞—Å –∏ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏.
- –Ø–Ω–≤–∞—Ä—å: —Å–æ–æ–±—â–µ–Ω–∏–µ‚Äë—Å–≤–æ–¥–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –∏ –∏—Ç–æ–≥–æ–≤—ã–º –º–µ—Ç—Ä–∞–∂–æ–º + –∏–Ω–ª–∞–π–Ω‚Äë–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
- –≠–∫—Å–ø–æ—Ä—Ç XLSX (`selection_to_workbook`) —Å–æ–∑–¥–∞—ë—Ç –ª–∏—Å—Ç—ã ¬´–ü–æ–¥–±–æ—Ä–∫–∞¬ª, ¬´–ò—Ç–æ–≥–∏¬ª, ¬´–ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞¬ª.
- ¬´‚úâÔ∏è –ú–µ–Ω–µ–¥–∂–µ—Ä—É¬ª –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–µ—Ç Excel –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞—è–≤–∫—É –≤ —á–∞—Ç `MANAGER_CHAT_ID`.

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä—É

- ¬´üì¶ –û–±—Ä–∞–∑—Ü—ã¬ª, ¬´üìÑ –ü–∞—Å–ø–æ—Ä—Ç¬ª, ¬´‚úâÔ∏è –ó–∞–ø—Ä–æ—Å —Å—á—ë—Ç–∞¬ª –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–∞—Ç–∞–ª–æ–≥–∞ ‚Üí –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–∏–Ω–≥.
- –§–æ—Ä–º—ã ¬´–û–±—Ä–∞–∑—Ü—ã¬ª, ¬´–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ –º–Ω–µ¬ª, ¬´–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å¬ª —Å–æ–±–∏—Ä–∞—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ —Ç—Ä–µ–±—É—é—Ç —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –ü–î–Ω.
- –í –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (mention_html).

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

- `RateLimitMiddleware` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–π/–∫–æ–ª–±—ç–∫–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`bot/middlewares/rate_limit.py`).
- Webhook –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ long polling —É–¥–∞–ª—è–µ—Ç—Å—è, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å `Conflict`.
- –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏ –≤ `tmp/` –ø–æ–º–æ–≥–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.

---

## –¢–µ—Å—Ç—ã –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

```bash
pytest            # unit-—Ç–µ—Å—Ç –º–∞—Å—Ç–µ—Ä–∞ –ø–æ–¥–±–æ—Ä–∞
ruff check .      # –ª–∏–Ω—Ç–∏–Ω–≥
black .           # –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ `ruff` –∏ `black` –ª–µ–∂–∞—Ç –≤ `pyproject.toml`.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ—Ä–æ—Ç–∫–æ

- `bot/main.py` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, middlewares, –∑–∞–ø—É—Å–∫ polling/webhook.
- `bot/handlers` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥, –∫–∞—Ç–∞–ª–æ–≥–∞, –º–∞—Å—Ç–µ—Ä–∞, –ø–æ–¥–±–æ—Ä–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∏.
- `bot/services` ‚Äî —Å—Ç–∞–±—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è/—Ü–µ–Ω, —ç–∫—Å–ø–æ—Ä—Ç Excel, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã.
- `bot/middlewares` ‚Äî rate-limit.
- `bot/utils/formatting.py` ‚Äî –æ–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã (calc_required, bulletize, mention_html).
- `tests/` ‚Äî —Ç–µ—Å—Ç—ã pytest.

---

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

- `/start`, `/help` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –º–µ–Ω—é.
- `/faq` ‚Äî —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `data/faq.md`.
- Reply‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –Ω–æ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∏ —Ç–µ–∫—Å—Ç–æ–º.

---

–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–º–æ: –º–∞—Å—Ç–µ—Ä –ø–æ–¥–±–æ—Ä–∞, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É, —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è –ø–æ–¥–±–æ—Ä–∫–∞, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä—É, —ç–∫—Å–ø–æ—Ä—Ç Excel –∏ –≥–æ—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É –∏ –æ–ø–ª–∞—Ç—É. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ç–µ–∫—Å—Ç—ã ‚Äî –∏–∑ —Ñ–∞–π–ª–æ–≤, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –ª–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å 1–° –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ø–∏—Ä–∞–π—Ç –≤—Ä—É—á–Ω—É—é.
